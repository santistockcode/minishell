[tox]
envlist = unit, integration-backend, integration-frontend
skipsdist = True
isolated_build = False

[testenv]
description = Base environment configuration
deps =
    pytest>=7.0
    pytest-timeout>=2.1.0
    pexpect>=4.8.0
setenv =
    MINISHELL_ROOT = {toxinidir}
    LIBFT_DIR = {toxinidir}/Libft
    TEST_SUPPORT_DIR = {toxinidir}/tests/support
passenv =
    HOME
    USER
    PATH
    TERM
allowlist_externals =
    make
    cc
    rm
    bash
    find

# ============================================================================
# Unit Tests (C with minunit)
# ============================================================================

[testenv:unit]
description = Run C unit tests using minunit
commands_pre =
    ; Build libft
    make -C {env:LIBFT_DIR}
commands =
    ; Run compiled unit tests
    python {toxinidir}/tests/support/scripts/compile_unit_tests.py --run

[testenv:unit-keep]
description = Run unit tests and keep compiled binaries
commands = {[testenv:unit]commands} --keep_bin

[testenv:unit-keep-debug]
description = Run unit tests and keep compiled binaries for debugging
commands = {[testenv:unit]commands} --keep_bin --debug

[testenv:unit-valgrind]
description = Run unit tests under Valgrind
commands = {[testenv:unit]commands} --valgrind

# ============================================================================
# Integration Tests - Backend
# ============================================================================

[testenv:integration-backend]
description = Run backend integration tests (execution engine)
commands_pre =
    ; Build libft
    make -C {env:LIBFT_DIR}
    ; Compile test API shared library
    python {toxinidir}/tests/support/scripts/compile_integration_api.py
commands =
    pytest {posargs:tests/integration/backend} -v
commands_post =
    ; Cleanup
    python {toxinidir}/tests/support/scripts/compile_integration_api.py --clean


[testenv:ib-hds]
description = Run only heredoc tests
commands_pre = {[testenv:integration-backend]commands_pre}
commands =
    pytest tests/integration/backend/test_here_docs.py -v

[testenv:ib-errors]
description = Run only error handling tests
commands_pre = {[testenv:integration-backend]commands_pre}
commands =
    pytest tests/integration/backend/test_error_handling.py -v
commands_post = {[testenv:integration-backend]commands_post}



# ============================================================================
# Integration Tests - Frontend
# ============================================================================

[testenv:integration-frontend]
description = Run frontend integration tests (parser/lexer)
commands =
    pytest {posargs:tests/integration/frontend} -v

# ============================================================================
# Manual/Interactive Tests
# ============================================================================

# TODO: Manual/Interactive Tests

# ============================================================================
# Combined Test Runs
# ============================================================================

[testenv:all]
description = Run all automated tests (unit + integration)
commands =
    {[testenv:unit]commands_pre}
    {[testenv:unit]commands}
    {[testenv:integration-backend]commands_pre}
    {[testenv:integration-backend]commands}
    {[testenv:integration-frontend]commands}
commands_post =
    {[testenv:integration-backend]commands_post}


# ============================================================================
# Cleanup
# ============================================================================

[testenv:clean]
description = Clean all test artifacts
commands =
    python {toxinidir}/tests/support/scripts/compile_integration_api.py --clean
    rm -rf .tox
    rm -rf .pytest_cache
    rm -f .here_doc_*
    find {toxinidir} -type d -name "__pycache__" -exec rm -rf {} +